<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
        }
        * {
            font-family: 'Sarabun', sans-serif;
        }
        .nav-btn {
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background: #D14D72;
            color: white;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(209, 77, 114, 0.1);
        }
        .input-field {
            border: 2px solid #FCC8D1;
            border-radius: 8px;
            padding: 10px 14px;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #D14D72;
            outline: none;
            box-shadow: 0 0 0 3px rgba(209, 77, 114, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #D14D72, #FFABAB);
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(209, 77, 114, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #FCC8D1;
            color: #D14D72;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: #FFABAB;
        }
        .table-header {
            background: linear-gradient(135deg, #D14D72, #FFABAB);
            color: white;
        }
        .table-row:nth-child(even) {
            background: #FEF2F4;
        }
        .table-row:hover {
            background: #FCC8D1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-[#FEF2F4] to-[#FCC8D1]">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-4"><img src="https://img5.pic.in.th/file/secure-sv1/logowatyaischool.png" alt="Logo" class="h-12 w-12 object-contain" loading="lazy" onerror="this.style.background='#FCC8D1'; this.alt='Logo';">
       <div>
        <h1 class="text-xl font-bold text-[#D14D72]">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h1>
        <p class="text-sm text-[#FFABAB]">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</p>
       </div>
      </div><button onclick="refreshData()" class="btn-secondary flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
       </svg> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
     </div>
    </div>
   </header><!-- Navigation -->
   <nav class="bg-white border-b border-[#FCC8D1] sticky top-20 z-40">
    <div class="max-w-7xl mx-auto px-4">
     <div class="flex gap-2 py-3 overflow-x-auto"><button onclick="showPage('settings')" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-[#D14D72] bg-[#FEF2F4] whitespace-nowrap" data-page="settings"> ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö </button> <button onclick="showPage('employees')" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-[#D14D72] bg-[#FEF2F4] whitespace-nowrap" data-page="employees"> üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô </button> <button onclick="showPage('payroll')" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-[#D14D72] bg-[#FEF2F4] whitespace-nowrap" data-page="payroll"> üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ </button> <button onclick="showPage('generate')" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-[#D14D72] bg-[#FEF2F4] whitespace-nowrap" data-page="generate"> üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ </button> <button onclick="showPage('history')" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-[#D14D72] bg-[#FEF2F4] whitespace-nowrap" data-page="history"> üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ </button>
     </div>
    </div>
   </nav><!-- Main Content -->
   <main class="max-w-7xl mx-auto px-4 py-6"><!-- Settings Page -->
    <div id="page-settings" class="page fade-in">
     <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üìÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä</label> <select id="setting-year" class="input-field w-full"> <!-- Years will be populated --> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <select id="setting-month" class="input-field w-full"> <option value="‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option> <option value="‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option> <option value="‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option> <option value="‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option> <option value="‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option> </select>
       </div>
      </div><button onclick="saveYearMonth()" class="btn-primary mt-4"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô </button>
     </div>
     <div class="card p-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üëî ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <div class="bg-[#FEF2F4] p-4 rounded-xl">
        <h3 class="font-semibold text-[#D14D72] mb-3">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
        <div class="space-y-3">
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label> <select id="director-prefix" class="input-field w-full"> <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option> <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option> <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label> <input type="text" id="director-firstname" class="input-field w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="director-lastname" class="input-field w-full" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
         </div>
        </div>
       </div>
       <div class="bg-[#FEF2F4] p-4 rounded-xl">
        <h3 class="font-semibold text-[#D14D72] mb-3">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <div class="space-y-3">
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label> <select id="finance-prefix" class="input-field w-full"> <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option> <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option> <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label> <input type="text" id="finance-firstname" class="input-field w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="finance-lastname" class="input-field w-full" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
         </div>
        </div>
       </div>
      </div><button onclick="saveAdmins()" class="btn-primary mt-4"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ </button>
     </div>
    </div><!-- Employees Page -->
    <div id="page-employees" class="page hidden fade-in">
     <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label> <select id="emp-prefix" class="input-field w-full"> <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option> <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option> <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label> <input type="text" id="emp-firstname" class="input-field w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="emp-lastname" class="input-field w-full" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label> <input type="text" id="emp-position" class="input-field w-full" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
       </div>
      </div><button onclick="addEmployee()" class="btn-primary mt-4"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô </button>
     </div>
     <div class="card p-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="table-header">
          <th class="px-4 py-3 text-left rounded-tl-lg">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="px-4 py-3 text-left">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
          <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="px-4 py-3 text-left">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="px-4 py-3 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
          <th class="px-4 py-3 text-center rounded-tr-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="employee-list">
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Payroll Page -->
    <div id="page-payroll" class="page hidden fade-in">
     <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label> <select id="payroll-employee" class="input-field w-full" onchange="loadPayrollData()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä</label> <select id="payroll-year" class="input-field w-full" onchange="loadPayrollData()"> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <select id="payroll-month" class="input-field w-full" onchange="loadPayrollData()"> <option value="‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option> <option value="‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option> <option value="‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option> <option value="‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option> <option value="‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option> </select>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Income Section -->
       <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
        <h3 class="font-bold text-green-700 mb-4 text-lg">üìà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h3>
        <div class="space-y-3">
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <input type="number" id="income-salary" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</label> <input type="number" id="income-compensation" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</label> <input type="number" id="income-academic" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</label> <input type="number" id="income-special" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô ‡∏û‡∏™‡∏£.</label> <input type="number" id="income-psr" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ï‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <input type="number" id="income-backpay" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div id="income-others" class="space-y-2">
         </div><button onclick="addOtherIncome()" class="text-green-600 text-sm font-medium hover:underline"> + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ </button>
         <div class="border-t-2 border-green-300 pt-3 mt-3">
          <div class="flex items-center justify-between font-bold text-green-700"><span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span> <span id="total-income">0.00</span>
          </div>
         </div>
        </div>
       </div><!-- Expense Section -->
       <div class="bg-red-50 p-4 rounded-xl border-2 border-red-200">
        <h3 class="font-bold text-red-700 mb-4 text-lg">üìâ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
        <div class="space-y-3">
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏©‡∏µ</label> <input type="number" id="expense-tax" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Ø</label> <input type="number" id="expense-coop" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ò.‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</label> <input type="number" id="expense-gsb" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ò.‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label> <input type="number" id="expense-ghb" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ò.‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</label> <input type="number" id="expense-ktb" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ò.‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°</label> <input type="number" id="expense-ibank" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏Å‡∏¢‡∏®.</label> <input type="number" id="expense-slf" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ä.‡∏û.‡∏Ñ.</label> <input type="number" id="expense-cpk" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏ä.‡∏û.‡∏™.</label> <input type="number" id="expense-cps" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div class="flex items-center gap-2"><label class="w-40 text-sm font-medium">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</label> <input type="number" id="expense-sso" class="input-field flex-1" placeholder="0" oninput="calculateTotals()">
         </div>
         <div id="expense-others" class="space-y-2">
         </div><button onclick="addOtherExpense()" class="text-red-600 text-sm font-medium hover:underline"> + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ </button>
         <div class="border-t-2 border-red-300 pt-3 mt-3">
          <div class="flex items-center justify-between font-bold text-red-700"><span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span> <span id="total-expense">0.00</span>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Net Income -->
      <div class="bg-[#D14D72] text-white p-4 rounded-xl mt-6">
       <div class="flex items-center justify-between text-xl font-bold"><span>üíµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span> <span id="net-income">0.00</span>
       </div>
      </div><button onclick="savePayroll()" class="btn-primary mt-4 w-full text-lg py-3"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ </button>
     </div>
    </div><!-- Generate Slip Page -->
    <div id="page-generate" class="page hidden fade-in">
     <div class="card p-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label> <select id="generate-employee" class="input-field w-full"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä</label> <select id="generate-year" class="input-field w-full"> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <select id="generate-month" class="input-field w-full"> <option value="‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option> <option value="‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option> <option value="‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option> <option value="‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option> <option value="‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option> </select>
       </div>
      </div><button onclick="generateSlip()" class="btn-primary w-full text-lg py-3"> üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ PDF </button>
     </div><!-- Preview Section -->
     <div id="slip-preview" class="card p-6 mt-6 hidden">
      <h3 class="text-lg font-bold text-[#D14D72] mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ</h3>
      <div id="preview-content" class="bg-white border-2 border-gray-200 p-6 rounded-lg">
      </div>
     </div>
    </div><!-- History Page -->
    <div id="page-history" class="page hidden fade-in">
     <div class="card p-6">
      <h2 class="text-lg font-bold text-[#D14D72] mb-4 flex items-center gap-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ</label> <select id="history-year" class="input-field w-full" onchange="filterHistory()"> <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <select id="history-month" class="input-field w-full" onchange="filterHistory()"> <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option> <option value="‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option> <option value="‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option> <option value="‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option> <option value="‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option> <option value="‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option> <option value="‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option> <option value="‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label> <select id="history-employee" class="input-field w-full" onchange="filterHistory()"> <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option> </select>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="table-header">
          <th class="px-4 py-3 text-left rounded-tl-lg">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="px-4 py-3 text-left">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
          <th class="px-4 py-3 text-left">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th>
          <th class="px-4 py-3 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
          <th class="px-4 py-3 text-center">‡πÑ‡∏ü‡∏•‡πå PDF</th>
          <th class="px-4 py-3 text-center rounded-tr-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="history-list">
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </main>
  </div>
  <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbwo32uHheUROA1sLrICtSYwEzo7LC4olAwKVAkfHnmg6jEYQsd5nLON9jnFlq-M0Ctk/exec';
        
        // State
        let appState = {
            settings: {
                year: new Date().getFullYear() + 543,
                month: getThaiMonth(new Date().getMonth()),
                director: { prefix: '‡∏ô‡∏≤‡∏¢', firstname: '', lastname: '' },
                finance: { prefix: '‡∏ô‡∏≤‡∏¢', firstname: '', lastname: '' }
            },
            employees: [],
            payrolls: [],
            slipHistory: [],
            otherIncomes: [],
            otherExpenses: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initYearSelects();
            showPage('settings');
            loadAllData();
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: { school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà' },
                    onConfigChange: async (config) => {},
                    mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
                    mapToEditPanelValues: (config) => new Map([['school_name', config.school_name || '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà']])
                });
            }
        });

        function getThaiMonth(monthIndex) {
            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                          '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            return months[monthIndex];
        }

        function initYearSelects() {
            const currentYear = new Date().getFullYear() + 543;
            const years = [];
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                years.push(y);
            }
            
            const yearSelects = ['setting-year', 'payroll-year', 'generate-year', 'history-year'];
            yearSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const includeAll = id === 'history-year';
                    select.innerHTML = includeAll ? '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>' : '';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + pageName).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageName) {
                    btn.classList.add('active');
                }
            });

            if (pageName === 'employees') {
                renderEmployeeList();
            } else if (pageName === 'payroll') {
                updateEmployeeSelects();
            } else if (pageName === 'generate') {
                updateEmployeeSelects();
            } else if (pageName === 'history') {
                updateEmployeeSelects();
                renderHistory();
            }
        }

        // JSONP Helper
        function jsonpRequest(params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                    reject(new Error('Request timeout'));
                }, 30000);

                window[callbackName] = function(response) {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                    resolve(response);
                };

                const queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key]))
                    .join('&');

                const script = document.createElement('script');
                script.src = API_URL + '?' + queryString + '&callback=' + callbackName;
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    reject(new Error('Script load error'));
                };
                document.body.appendChild(script);
            });
        }

        // Data Operations
        async function loadAllData() {
            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await jsonpRequest({ action: 'getAllData' });
                
                if (response.success) {
                    if (response.data.settings) {
                        appState.settings = { ...appState.settings, ...response.data.settings };
                        loadSettingsToForm();
                    }
                    if (response.data.employees) {
                        appState.employees = response.data.employees;
                        renderEmployeeList();
                        updateEmployeeSelects();
                    }
                    if (response.data.payrolls) {
                        appState.payrolls = response.data.payrolls;
                    }
                    if (response.data.slipHistory) {
                        appState.slipHistory = response.data.slipHistory;
                        renderHistory();
                    }
                }
                
                Swal.close();
            } catch (error) {
                console.error('Load error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                });
            }
        }

        function refreshData() {
            loadAllData();
        }

        function loadSettingsToForm() {
            document.getElementById('setting-year').value = appState.settings.year;
            document.getElementById('setting-month').value = appState.settings.month;
            
            if (appState.settings.director) {
                document.getElementById('director-prefix').value = appState.settings.director.prefix || '‡∏ô‡∏≤‡∏¢';
                document.getElementById('director-firstname').value = appState.settings.director.firstname || '';
                document.getElementById('director-lastname').value = appState.settings.director.lastname || '';
            }
            
            if (appState.settings.finance) {
                document.getElementById('finance-prefix').value = appState.settings.finance.prefix || '‡∏ô‡∏≤‡∏¢';
                document.getElementById('finance-firstname').value = appState.settings.finance.firstname || '';
                document.getElementById('finance-lastname').value = appState.settings.finance.lastname || '';
            }
        }

        async function saveYearMonth() {
            const year = document.getElementById('setting-year').value;
            const month = document.getElementById('setting-month').value;

            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await jsonpRequest({
                    action: 'saveSettings',
                    data: { year, month }
                });

                if (response.success) {
                    appState.settings.year = year;
                    appState.settings.month = month;
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
                });
            }
        }

        async function saveAdmins() {
            const director = {
                prefix: document.getElementById('director-prefix').value,
                firstname: document.getElementById('director-firstname').value,
                lastname: document.getElementById('director-lastname').value
            };
            const finance = {
                prefix: document.getElementById('finance-prefix').value,
                firstname: document.getElementById('finance-firstname').value,
                lastname: document.getElementById('finance-lastname').value
            };

            if (!director.firstname || !director.lastname) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö' });
                return;
            }
            if (!finance.firstname || !finance.lastname) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö' });
                return;
            }

            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await jsonpRequest({
                    action: 'saveAdmins',
                    data: { director, finance }
                });

                if (response.success) {
                    appState.settings.director = director;
                    appState.settings.finance = finance;
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
                });
            }
        }

        // Employee Management
        async function addEmployee() {
            const prefix = document.getElementById('emp-prefix').value;
            const firstname = document.getElementById('emp-firstname').value.trim();
            const lastname = document.getElementById('emp-lastname').value.trim();
            const position = document.getElementById('emp-position').value.trim();

            if (!firstname || !lastname || !position) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
                return;
            }

            const employee = {
                id: 'EMP' + Date.now(),
                prefix,
                firstname,
                lastname,
                position
            };

            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await jsonpRequest({
                    action: 'addEmployee',
                    data: employee
                });

                if (response.success) {
                    appState.employees.push(employee);
                    renderEmployeeList();
                    updateEmployeeSelects();
                    
                    document.getElementById('emp-firstname').value = '';
                    document.getElementById('emp-lastname').value = '';
                    document.getElementById('emp-position').value = '';

                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
                });
            }
        }

        function renderEmployeeList() {
            const tbody = document.getElementById('employee-list');
            if (!tbody) return;

            if (appState.employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }

            tbody.innerHTML = appState.employees.map((emp, index) => `
                <tr class="table-row border-b border-gray-100">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${emp.prefix}</td>
                    <td class="px-4 py-3">${emp.firstname}</td>
                    <td class="px-4 py-3">${emp.lastname}</td>
                    <td class="px-4 py-3">${emp.position}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:text-red-700 font-medium">
                            üóëÔ∏è ‡∏•‡∏ö
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteEmployee(empId) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#D14D72',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const response = await jsonpRequest({
                        action: 'deleteEmployee',
                        data: { id: empId }
                    });

                    if (response.success) {
                        appState.employees = appState.employees.filter(e => e.id !== empId);
                        renderEmployeeList();
                        updateEmployeeSelects();
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
                    });
                }
            }
        }

        function updateEmployeeSelects() {
            const selects = ['payroll-employee', 'generate-employee', 'history-employee'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const includeAll = id === 'history-employee';
                    const currentValue = select.value;
                    select.innerHTML = includeAll ? '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>' : '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';
                    appState.employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.prefix}${emp.firstname} ${emp.lastname} (${emp.position})`;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // Payroll Management
        let otherIncomeCount = 0;
        let otherExpenseCount = 0;

        function addOtherIncome() {
            otherIncomeCount++;
            const container = document.getElementById('income-others');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.id = `other-income-${otherIncomeCount}`;
            div.innerHTML = `
                <input type="text" class="input-field w-32" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" id="other-income-name-${otherIncomeCount}">
                <input type="number" class="input-field flex-1" placeholder="0" id="other-income-amount-${otherIncomeCount}" oninput="calculateTotals()">
                <button onclick="removeOtherIncome(${otherIncomeCount})" class="text-red-500 hover:text-red-700">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeOtherIncome(id) {
            const el = document.getElementById(`other-income-${id}`);
            if (el) el.remove();
            calculateTotals();
        }

        function addOtherExpense() {
            otherExpenseCount++;
            const container = document.getElementById('expense-others');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.id = `other-expense-${otherExpenseCount}`;
            div.innerHTML = `
                <input type="text" class="input-field w-32" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" id="other-expense-name-${otherExpenseCount}">
                <input type="number" class="input-field flex-1" placeholder="0" id="other-expense-amount-${otherExpenseCount}" oninput="calculateTotals()">
                <button onclick="removeOtherExpense(${otherExpenseCount})" class="text-red-500 hover:text-red-700">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeOtherExpense(id) {
            const el = document.getElementById(`other-expense-${id}`);
            if (el) el.remove();
            calculateTotals();
        }

        function calculateTotals() {
            let totalIncome = 0;
            const incomeFields = ['salary', 'compensation', 'academic', 'special', 'psr', 'backpay'];
            incomeFields.forEach(field => {
                const value = parseFloat(document.getElementById(`income-${field}`)?.value) || 0;
                totalIncome += value;
            });

            document.querySelectorAll('[id^="other-income-amount-"]').forEach(input => {
                totalIncome += parseFloat(input.value) || 0;
            });

            let totalExpense = 0;
            const expenseFields = ['tax', 'coop', 'gsb', 'ghb', 'ktb', 'ibank', 'slf', 'cpk', 'cps', 'sso'];
            expenseFields.forEach(field => {
                const value = parseFloat(document.getElementById(`expense-${field}`)?.value) || 0;
                totalExpense += value;
            });

            document.querySelectorAll('[id^="other-expense-amount-"]').forEach(input => {
                totalExpense += parseFloat(input.value) || 0;
            });

            const netIncome = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2 });
            document.getElementById('total-expense').textContent = totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2 });
            document.getElementById('net-income').textContent = netIncome.toLocaleString('th-TH', { minimumFractionDigits: 2 });
        }

        function getPayrollData() {
            const incomeFields = ['salary', 'compensation', 'academic', 'special', 'psr', 'backpay'];
            const expenseFields = ['tax', 'coop', 'gsb', 'ghb', 'ktb', 'ibank', 'slf', 'cpk', 'cps', 'sso'];
            
            const income = {};
            incomeFields.forEach(field => {
                income[field] = parseFloat(document.getElementById(`income-${field}`)?.value) || 0;
            });

            const otherIncomes = [];
            document.querySelectorAll('[id^="other-income-name-"]').forEach(input => {
                const id = input.id.replace('other-income-name-', '');
                const name = input.value;
                const amount = parseFloat(document.getElementById(`other-income-amount-${id}`)?.value) || 0;
                if (name && amount > 0) {
                    otherIncomes.push({ name, amount });
                }
            });
            income.others = otherIncomes;

            const expense = {};
            expenseFields.forEach(field => {
                expense[field] = parseFloat(document.getElementById(`expense-${field}`)?.value) || 0;
            });

            const otherExpenses = [];
            document.querySelectorAll('[id^="other-expense-name-"]').forEach(input => {
                const id = input.id.replace('other-expense-name-', '');
                const name = input.value;
                const amount = parseFloat(document.getElementById(`other-expense-amount-${id}`)?.value) || 0;
                if (name && amount > 0) {
                    otherExpenses.push({ name, amount });
                }
            });
            expense.others = otherExpenses;

            return { income, expense };
        }

        function loadPayrollData() {
            const empId = document.getElementById('payroll-employee').value;
            const year = document.getElementById('payroll-year').value;
            const month = document.getElementById('payroll-month').value;

            if (!empId) return;

            const existingPayroll = appState.payrolls.find(p => 
                p.employeeId === empId && p.year === year && p.month === month
            );

            const incomeFields = ['salary', 'compensation', 'academic', 'special', 'psr', 'backpay'];
            const expenseFields = ['tax', 'coop', 'gsb', 'ghb', 'ktb', 'ibank', 'slf', 'cpk', 'cps', 'sso'];
            
            incomeFields.forEach(field => {
                const el = document.getElementById(`income-${field}`);
                if (el) el.value = '';
            });
            expenseFields.forEach(field => {
                const el = document.getElementById(`expense-${field}`);
                if (el) el.value = '';
            });

            document.getElementById('income-others').innerHTML = '';
            document.getElementById('expense-others').innerHTML = '';
            otherIncomeCount = 0;
            otherExpenseCount = 0;

            if (existingPayroll) {
                if (existingPayroll.income) {
                    incomeFields.forEach(field => {
                        const el = document.getElementById(`income-${field}`);
                        if (el && existingPayroll.income[field]) {
                            el.value = existingPayroll.income[field];
                        }
                    });
                    if (existingPayroll.income.others) {
                        existingPayroll.income.others.forEach(item => {
                            addOtherIncome();
                            document.getElementById(`other-income-name-${otherIncomeCount}`).value = item.name;
                            document.getElementById(`other-income-amount-${otherIncomeCount}`).value = item.amount;
                        });
                    }
                }

                if (existingPayroll.expense) {
                    expenseFields.forEach(field => {
                        const el = document.getElementById(`expense-${field}`);
                        if (el && existingPayroll.expense[field]) {
                            el.value = existingPayroll.expense[field];
                        }
                    });
                    if (existingPayroll.expense.others) {
                        existingPayroll.expense.others.forEach(item => {
                            addOtherExpense();
                            document.getElementById(`other-expense-name-${otherExpenseCount}`).value = item.name;
                            document.getElementById(`other-expense-amount-${otherExpenseCount}`).value = item.amount;
                        });
                    }
                }
            }

            calculateTotals();
        }

        async function savePayroll() {
            const employeeId = document.getElementById('payroll-employee').value;
            const year = document.getElementById('payroll-year').value;
            const month = document.getElementById('payroll-month').value;

            if (!employeeId) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' });
                return;
            }

            const employee = appState.employees.find(e => e.id === employeeId);
            const payrollData = getPayrollData();

            const totalIncome = parseFloat(document.getElementById('total-income').textContent.replace(/,/g, ''));
            const totalExpense = parseFloat(document.getElementById('total-expense').textContent.replace(/,/g, ''));
            const netIncome = parseFloat(document.getElementById('net-income').textContent.replace(/,/g, ''));

            const payroll = {
                id: 'PAY' + Date.now(),
                employeeId,
                employeeName: `${employee.prefix}${employee.firstname} ${employee.lastname}`,
                position: employee.position,
                year,
                month,
                income: payrollData.income,
                expense: payrollData.expense,
                totalIncome,
                totalExpense,
                netIncome,
                createdAt: new Date().toISOString()
            };

            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await jsonpRequest({
                    action: 'savePayroll',
                    data: payroll
                });

                if (response.success) {
                    const existingIndex = appState.payrolls.findIndex(p => 
                        p.employeeId === employeeId && p.year === year && p.month === month
                    );
                    if (existingIndex >= 0) {
                        appState.payrolls[existingIndex] = payroll;
                    } else {
                        appState.payrolls.push(payroll);
                    }

                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
                });
            }
        }

        // Generate Slip
        async function generateSlip() {
            const employeeId = document.getElementById('generate-employee').value;
            const year = document.getElementById('generate-year').value;
            const month = document.getElementById('generate-month').value;

            if (!employeeId) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' });
                return;
            }

            const employee = appState.employees.find(e => e.id === employeeId);
            const payroll = appState.payrolls.find(p => 
                p.employeeId === employeeId && p.year === year && p.month === month
            );

            if (!payroll) {
                Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ' });
                return;
            }

            if (!appState.settings.director?.firstname || !appState.settings.finance?.firstname) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πà‡∏≠‡∏ô' });
                return;
            }

            showSlipPreview(employee, payroll);

            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const slipData = {
                    employee,
                    payroll,
                    year,
                    month,
                    director: appState.settings.director,
                    finance: appState.settings.finance
                };

                const response = await jsonpRequest({
                    action: 'generateSlipPdf',
                    data: slipData
                });

                if (response.success) {
                    const historyItem = {
                        id: 'SLIP' + Date.now(),
                        employeeId,
                        employeeName: `${employee.prefix}${employee.firstname} ${employee.lastname}`,
                        position: employee.position,
                        year,
                        month,
                        netIncome: payroll.netIncome,
                        pdfUrl: response.pdfUrl,
                        createdAt: new Date().toISOString()
                    };
                    appState.slipHistory.unshift(historyItem);
                    renderHistory();

                    Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        html: `<p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p><a href="${response.pdfUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå PDF</a>`,
                        showConfirmButton: true
                    });
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ'
                });
            }
        }

        function showSlipPreview(employee, payroll) {
            const preview = document.getElementById('slip-preview');
            const content = document.getElementById('preview-content');
            
            const incomeLabels = {
                salary: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                compensation: '‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô',
                academic: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞',
                special: '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                psr: '‡πÄ‡∏á‡∏¥‡∏ô ‡∏û‡∏™‡∏£.',
                backpay: '‡∏ï‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
            };

            const expenseLabels = {
                tax: '‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏©‡∏µ',
                coop: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Ø',
                gsb: '‡∏ò.‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô',
                ghb: '‡∏ò.‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå',
                ktb: '‡∏ò.‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢',
                ibank: '‡∏ò.‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°',
                slf: '‡∏Å‡∏¢‡∏®.',
                cpk: '‡∏ä.‡∏û.‡∏Ñ.',
                cps: '‡∏ä.‡∏û.‡∏™.',
                sso: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°'
            };

            let incomeRows = '';
            Object.keys(incomeLabels).forEach(key => {
                const value = payroll.income[key] || 0;
                incomeRows += `<tr><td class="border px-2 py-1">${incomeLabels[key]}</td><td class="border px-2 py-1 text-right">${value > 0 ? value.toLocaleString('th-TH', {minimumFractionDigits: 2}) : '-'}</td></tr>`;
            });
            if (payroll.income.others) {
                payroll.income.others.forEach(item => {
                    incomeRows += `<tr><td class="border px-2 py-1">${item.name}</td><td class="border px-2 py-1 text-right">${item.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td></tr>`;
                });
            }

            let expenseRows = '';
            Object.keys(expenseLabels).forEach(key => {
                const value = payroll.expense[key] || 0;
                expenseRows += `<tr><td class="border px-2 py-1">${expenseLabels[key]}</td><td class="border px-2 py-1 text-right">${value > 0 ? value.toLocaleString('th-TH', {minimumFractionDigits: 2}) : '-'}</td></tr>`;
            });
            if (payroll.expense.others) {
                payroll.expense.others.forEach(item => {
                    expenseRows += `<tr><td class="border px-2 py-1">${item.name}</td><td class="border px-2 py-1 text-right">${item.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td></tr>`;
                });
            }

            content.innerHTML = `
                <div class="text-center mb-4">
                    <img src="https://img5.pic.in.th/file/secure-sv1/logowatyaischool.png" alt="Logo" class="h-12 mx-auto mb-2" loading="lazy" onerror="this.style.background='#FCC8D1'; this.alt='Logo';">
                    <h2 class="text-xl font-bold text-[#D14D72]">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                    <p class="font-semibold">${employee.position} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</p>
                    <p>‡∏Ç‡∏≠‡∏á ${employee.prefix}${employee.firstname} ${employee.lastname} ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${payroll.month} ‡∏û.‡∏®. ${payroll.year}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold text-green-700 mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h3>
                        <table class="w-full text-sm">
                            <tbody>${incomeRows}</tbody>
                            <tfoot>
                                <tr class="font-bold bg-green-100">
                                    <td class="border px-2 py-1">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</td>
                                    <td class="border px-2 py-1 text-right">${payroll.totalIncome.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div>
                        <h3 class="font-bold text-red-700 mb-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                        <table class="w-full text-sm">
                            <tbody>${expenseRows}</tbody>
                            <tfoot>
                                <tr class="font-bold bg-red-100">
                                    <td class="border px-2 py-1">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</td>
                                    <td class="border px-2 py-1 text-right">${payroll.totalExpense.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-[#D14D72] text-white rounded-lg text-center">
                    <span class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${payroll.netIncome.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="grid grid-cols-2 gap-8 mt-8 text-center">
                    <div>
                        <p class="border-t border-gray-400 pt-2 mt-8">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠......................................</p>
                        <p>(${appState.settings.finance.prefix}${appState.settings.finance.firstname} ${appState.settings.finance.lastname})</p>
                        <p>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</p>
                    </div>
                    <div>
                        <p class="border-t border-gray-400 pt-2 mt-8">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠......................................</p>
                        <p>(${appState.settings.director.prefix}${appState.settings.director.firstname} ${appState.settings.director.lastname})</p>
                        <p>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
                    </div>
                </div>
            `;

            preview.classList.remove('hidden');
        }

        // History
        function renderHistory() {
            const tbody = document.getElementById('history-list');
            if (!tbody) return;

            const yearFilter = document.getElementById('history-year')?.value;
            const monthFilter = document.getElementById('history-month')?.value;
            const empFilter = document.getElementById('history-employee')?.value;

            let filtered = appState.slipHistory.filter(item => {
                if (yearFilter && item.year !== yearFilter) return false;
                if (monthFilter && item.month !== monthFilter) return false;
                if (empFilter && item.employeeId !== empFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map((item, index) => `
                <tr class="table-row border-b border-gray-100">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${item.employeeName}</td>
                    <td class="px-4 py-3">${item.month} ${item.year}</td>
                    <td class="px-4 py-3 text-right font-semibold text-green-600">${item.netIncome.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 text-center">
                        ${item.pdfUrl ? `<a href="${item.pdfUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">üìÑ ‡∏î‡∏π PDF</a>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteHistory('${item.id}')" class="text-red-500 hover:text-red-700 font-medium">
                            üóëÔ∏è ‡∏•‡∏ö
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterHistory() {
            renderHistory();
        }

        async function deleteHistory(id) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#D14D72',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const response = await jsonpRequest({
                        action: 'deleteHistory',
                        data: { id }
                    });

                    if (response.success) {
                        appState.slipHistory = appState.slipHistory.filter(h => h.id !== id);
                        renderHistory();
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ'
                    });
                }
            }
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cc12df3e4eb732e',t:'MTc3MDc4NDk0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>